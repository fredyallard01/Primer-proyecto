{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}
  <h1 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Write a Review</h1>
  <form method="post" enctype="multipart/form-data" class="space-y-4 transition-all duration-700 ease-in-out animate-fade-in">{% csrf_token %}

    <label for="rating-input" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">Rating</label>
    <input type="number" id="rating-input" name="rating" min="1" max="5" value="1" class="w-full bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-300 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">

    <label for="editor" class="block text-sm font-medium mb-1 text-gray-900 dark:text-white">Comment</label>
    <div class="space-y-2 transition-all duration-700 ease-in-out">
      <textarea id="editor" name="content" class="w-full min-h-screen bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-300 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>    
    </div>

    <button type="submit" class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white dark:bg-green-600 dark:hover:bg-green-700 rounded transition-all duration-500 ease-in-out">Submit Review</button>

    <script>
      ClassicEditor
        .create(document.querySelector('#editor'), {
          extraPlugins: [CustomUploadAdapterPlugin]
        })
        .then(editor => {
          editor.editing.view.change(writer => writer.setStyle('min-height', '90vh', editor.editing.view.document.getRoot()));
          const editableElement = editor.ui.view.editable.element;

          const isDark = document.documentElement.classList.contains('dark');
          if (isDark) {
            editor.editing.view.change(writer => {
              writer.setStyle('background-color', '#374151', editor.editing.view.document.getRoot()); // gray-700
              writer.setStyle('color', '#D1D5DB', editor.editing.view.document.getRoot()); // gray-300
            });
          }
          editableElement.classList.add(
            'bg-white', 'dark:bg-gray-700',
            'text-gray-900', 'dark:text-gray-300',
            'px-4', 'py-2',
            'rounded-lg',
            'border', 'border-gray-300', 'dark:border-gray-600',
            'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500'
          );
        })
        .catch(error => {
          console.error('Error initializing CKEditor:', error);
        });

      function CustomUploadAdapterPlugin(editor) {
        editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
          return new UploadAdapter(loader);
        };
      }

      class UploadAdapter {
        constructor(loader) {
          this.loader = loader;
        }

        upload() {
          return this.loader.file.then(file => {
            const data = new FormData();
            data.append('upload', file);

            return fetch('/upload/', {
              method: 'POST',
              body: data,
              headers: {
                'X-CSRFToken': '{{ csrf_token }}'
              }
            })
              .then(response => response.json())
              .then(data => {
                return {
                  default: data.url  // tu backend debe devolver JSON con la URL
                };
              });
          });
        }

        abort() {}
      }
    </script>

    <script>
      const ratingInput = document.getElementById('rating-input');
      ratingInput.addEventListener('input', () => {
        let val = parseFloat(ratingInput.value);
        val = Math.round(val);
        
        if (val > 5) val = 5;
        if (val < 1) val = 1;
        ratingInput.value = val;
      });
    </script>

  </form>
{% endblock %}
